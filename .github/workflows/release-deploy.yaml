name: Release Deploy
run-name: release deploy ${{ github.event.release.tag_name }}

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to ${{ matrix.host }}
    runs-on: [self-hosted, linux, deployer]
    strategy:
      fail-fast: false
      matrix:
        host: [stream.lan, strih.lan, resolume.lan]
    steps:
      - name: Download release artifact
        run: |
          gh release download "${{ github.event.release.tag_name }}" \
            --repo "${{ github.repository }}" \
            --pattern "OBS-Studio-*-Windows-x64.zip" \
            --dir ./release-artifacts
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Stop OBS
        run: |
          ssh ${{ matrix.host }} 'taskkill /IM obs64.exe /F' 2>/dev/null || true
          sleep 3

      - name: Deploy OBS Studio
        run: |
          cd release-artifacts
          ZIP_FILE=$(ls *.zip 2>/dev/null | head -1)
          if [ -z "$ZIP_FILE" ]; then
            echo "FAIL: No ZIP file found"
            ls -la
            exit 1
          fi
          echo "Deploying: $ZIP_FILE"
          scp "$ZIP_FILE" '${{ matrix.host }}:C:\Temp\obs-update.zip'
          ssh ${{ matrix.host }} 'powershell -Command "Expand-Archive -Path \"C:\Temp\obs-update.zip\" -DestinationPath \"C:\Program Files\obs-studio\" -Force"'
          ssh ${{ matrix.host }} 'del "C:\Temp\obs-update.zip"'

      - name: Start OBS
        run: |
          ssh ${{ matrix.host }} 'schtasks /Run /TN "StartOBS"'
          echo "Waiting 15s for OBS startup..."
          sleep 15

      - name: Verify deployment
        run: |
          ssh ${{ matrix.host }} 'tasklist /FI "IMAGENAME eq obs64.exe"' | grep -q obs64.exe \
            || { echo "FAIL: OBS not running on ${{ matrix.host }}"; exit 1; }
          echo "OBS is running on ${{ matrix.host }}"

      - name: Cleanup
        if: always()
        run: rm -rf release-artifacts/
