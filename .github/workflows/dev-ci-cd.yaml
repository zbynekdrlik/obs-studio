name: Dev CI/CD
run-name: dev deploy ${{ github.sha }}

on:
  push:
    branches: [dev]

permissions:
  contents: read
  actions: read

jobs:
  check-event:
    name: Event Data ðŸ”Ž
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash
    outputs:
      package: ${{ steps.setup.outputs.package }}
      config: ${{ steps.setup.outputs.config }}
      commitHash: ${{ steps.setup.outputs.commitHash }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check Event Data â˜‘ï¸
        id: setup
        run: |
          echo "package=true" >> $GITHUB_OUTPUT
          echo "config=RelWithDebInfo" >> $GITHUB_OUTPUT
          echo "commitHash=${GITHUB_SHA:0:9}" >> $GITHUB_OUTPUT

  windows-build:
    name: Windows ðŸªŸ (x64)
    runs-on: windows-2022
    needs: check-event
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Build OBS Studio ðŸ§±
        uses: ./.github/actions/build-obs
        env:
          TWITCH_CLIENTID: ${{ secrets.TWITCH_CLIENT_ID }}
          TWITCH_HASH: ${{ secrets.TWITCH_HASH }}
          RESTREAM_CLIENTID: ${{ secrets.RESTREAM_CLIENTID }}
          RESTREAM_HASH: ${{ secrets.RESTREAM_HASH }}
          YOUTUBE_CLIENTID: ${{ secrets.YOUTUBE_CLIENTID }}
          YOUTUBE_CLIENTID_HASH: ${{ secrets.YOUTUBE_CLIENTID_HASH }}
          YOUTUBE_SECRET: ${{ secrets.YOUTUBE_SECRET }}
          YOUTUBE_SECRET_HASH: ${{ secrets.YOUTUBE_SECRET_HASH }}
          GPU_PRIORITY_VAL: ${{ secrets.GPU_PRIORITY_VAL }}
        with:
          target: x64
          config: ${{ needs.check-event.outputs.config }}

      - name: Package OBS Studio ðŸ“€
        uses: ./.github/actions/package-obs
        with:
          target: x64
          config: ${{ needs.check-event.outputs.config }}
          package: ${{ fromJSON(needs.check-event.outputs.package) }}

      - name: Upload Artifacts ðŸ“¡
        uses: actions/upload-artifact@v4
        with:
          name: obs-studio-windows-x64-${{ needs.check-event.outputs.commitHash }}
          path: ${{ github.workspace }}/build_x64/obs-studio-*-windows-x64.zip

  deploy:
    name: Deploy to stream.lan
    needs: windows-build
    runs-on: [self-hosted, linux, deployer]
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          pattern: "obs-studio-windows-x64-*"
          merge-multiple: false

      - name: Stop OBS
        run: |
          ssh stream.lan 'taskkill /IM obs64.exe /F' 2>/dev/null || true
          sleep 3

      - name: Deploy OBS Studio
        run: |
          ARTIFACT_DIR=$(ls -d obs-studio-windows-x64-*/ 2>/dev/null | head -1)
          if [ -z "$ARTIFACT_DIR" ]; then
            echo "FAIL: No artifact directory found"
            ls -la
            exit 1
          fi
          echo "Using artifact directory: $ARTIFACT_DIR"

          cd "$ARTIFACT_DIR"
          ZIP_FILE=$(ls *.zip 2>/dev/null | head -1)
          if [ -z "$ZIP_FILE" ]; then
            echo "FAIL: No ZIP file found in $ARTIFACT_DIR"
            ls -la
            exit 1
          fi
          echo "Deploying: $ZIP_FILE"

          # Transfer ZIP to target
          scp "$ZIP_FILE" 'stream.lan:C:\Temp\obs-update.zip'

          # Extract over existing installation
          ssh stream.lan 'powershell -Command "Expand-Archive -Path \"C:\Temp\obs-update.zip\" -DestinationPath \"C:\Program Files\obs-studio\" -Force"'

          # Clean up temp file
          ssh stream.lan 'del "C:\Temp\obs-update.zip"'

          echo "Deployment complete"

      - name: Start OBS
        run: |
          ssh stream.lan 'schtasks /Run /TN "StartOBS"'
          echo "Waiting 15s for OBS startup..."
          sleep 15

      - name: Verify deployment
        run: |
          echo "=== Checking OBS process ==="
          ssh stream.lan 'tasklist /FI "IMAGENAME eq obs64.exe"' | grep -q obs64.exe \
            || { echo "FAIL: OBS not running"; exit 1; }
          echo "OBS is running"

      - name: Cleanup
        if: always()
        run: rm -rf obs-studio-windows-x64-*/
